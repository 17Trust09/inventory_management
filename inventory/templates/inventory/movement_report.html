{% extends 'inventory/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">ðŸ“¦ Lagerbewegungen</h2>
    <a class="btn btn-outline-light" href="{% url 'dashboards' %}">ZurÃ¼ck zu Dashboards</a>
  </div>

  <div class="card mb-4" style="background:var(--surface); border:1px solid var(--border); color:var(--text);">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Aktion</label>
          <select class="form-select" name="action">
            <option value="">Alle</option>
            {% for value, label in action_choices %}
              <option value="{{ value }}" {% if selected_action == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Dashboard</label>
          <select class="form-select" name="overview">
            <option value="">Alle</option>
            {% for ov in overview_list %}
              <option value="{{ ov.id }}" {% if selected_overview == ov.id|stringformat:'s' %}selected{% endif %}>
                {{ ov.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Benutzer</label>
          <select class="form-select" name="user">
            <option value="">Alle</option>
            {% for u in users %}
              <option value="{{ u.id }}" {% if selected_user == u.id|stringformat:'s' %}selected{% endif %}>
                {{ u.username }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Zeitraum</label>
          <select class="form-select" name="days">
            <option value="">Gesamt</option>
            <option value="7" {% if selected_days == '7' %}selected{% endif %}>Letzte 7 Tage</option>
            <option value="30" {% if selected_days == '30' %}selected{% endif %}>Letzte 30 Tage</option>
            <option value="90" {% if selected_days == '90' %}selected{% endif %}>Letzte 90 Tage</option>
          </select>
        </div>
        <div class="col-md-1">
          <button class="btn btn-outline-primary w-100">Filtern</button>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card h-100" style="background:var(--surface); border:1px solid var(--border); color:var(--text);">
        <div class="card-body">
          <div class="fw-semibold mb-2">Top-Bewegungen (Items)</div>
          {% if top_items %}
            <ol class="mb-0">
              {% for entry in top_items %}
                <li>{{ entry.name }} <span class="text-muted">({{ entry.count }})</span></li>
              {% endfor %}
            </ol>
          {% else %}
            <div class="text-muted">Keine Daten vorhanden.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100" style="background:var(--surface); border:1px solid var(--border); color:var(--text);">
        <div class="card-body">
          <div class="fw-semibold mb-2">Hotspots (Lagerorte)</div>
          {% if top_locations %}
            <ol class="mb-0">
              {% for entry in top_locations %}
                <li>{{ entry.name }} <span class="text-muted">({{ entry.count }})</span></li>
              {% endfor %}
            </ol>
          {% else %}
            <div class="text-muted">Keine Daten vorhanden.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if page_obj %}
    <div class="list-group">
      {% for entry in page_obj %}
        <div class="list-group-item"
             style="background:var(--surface); color:var(--text); border:1px solid var(--border);">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">
                {{ entry.item.name }}
                {% if entry.item.overview %}<span class="text-muted">â€¢ {{ entry.item.overview.name }}</span>{% endif %}
              </div>
              <div class="text-muted small">
                {{ entry.created_at|date:"d.m.Y H:i" }}
                {% if entry.user %}â€¢ {{ entry.user.username }}{% endif %}
              </div>
            </div>
            <span class="badge bg-info text-dark">{{ entry.get_action_display }}</span>
          </div>

          {% if entry.changes %}
            <ul class="mt-2 mb-0 small">
              {% for change in entry.changes %}
                <li>
                  <strong>{{ change.label }}:</strong>
                  {{ change.before }} â†’ {{ change.after }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted small mt-2">Keine Details vorhanden.</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    {% if paginator.num_pages > 1 %}
      <nav class="mt-3">
        <ul class="pagination">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{% if selected_overview %}overview={{ selected_overview }}&{% endif %}{% if selected_user %}user={{ selected_user }}&{% endif %}{% if selected_days %}days={{ selected_days }}&{% endif %}page={{ page_obj.previous_page_number }}">ZurÃ¼ck</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">ZurÃ¼ck</span></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">{{ page_obj.number }} / {{ paginator.num_pages }}</span></li>
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{% if selected_overview %}overview={{ selected_overview }}&{% endif %}{% if selected_user %}user={{ selected_user }}&{% endif %}{% if selected_days %}days={{ selected_days }}&{% endif %}page={{ page_obj.next_page_number }}">Weiter</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Weiter</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  {% else %}
    <div class="alert alert-info">Keine Lagerbewegungen gefunden.</div>
  {% endif %}
</div>
{% endblock %}
