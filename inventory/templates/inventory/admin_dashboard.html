{% extends 'inventory/admin_base.html' %}

{% block content %}
<div class="container py-4">

  <h2 class="mb-4">‚öôÔ∏è Admin Dashboard</h2>

  {% if not request.user.is_superuser and not tailscale_setup_complete %}
    <div class="alert alert-warning">
      <strong>Setup erforderlich:</strong> Bevor weitere Admin-Funktionen sichtbar sind, muss das Tailscale-Setup
      abgeschlossen werden. Bitte f√ºhre den Wizard aus und teile das Ger√§t mit dem Admin.
      <div class="mt-2">
        <a class="btn btn-outline-light btn-sm" href="{% url 'admin_tailscale_setup' %}">
          Zum Tailscale-Setup
        </a>
      </div>
    </div>
  {% endif %}

  {% if request.user.is_superuser or tailscale_setup_complete %}
    <div class="row g-4">

    <!-- Benutzer & Konfiguration -->
    <div class="col-12 col-lg-4">
      <div class="card h-100 shadow-sm" style="background:var(--surface); border:1px solid var(--border); border-radius:.75rem;">
        <div class="card-header fw-semibold" style="background:var(--surface-2); border-bottom:1px solid var(--border); color:var(--text);">
          üë• Benutzer &amp; Konfiguration
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
            <a class="text-decoration-none" href="{% url 'admin_user_profiles' %}">
              <i class="bi bi-people me-2"></i> User Profiles
            </a>
          </li>
          <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
            <a class="text-decoration-none" href="{% url 'admin_global_settings' %}">
              <i class="bi bi-gear me-2"></i> Globale Einstellungen
            </a>
          </li>
          {% if request.user.is_superuser %}
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_feature_toggles' %}">
                <i class="bi bi-toggles me-2"></i> Feature-Schalter
              </a>
            </li>
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_updates' %}">
                <i class="bi bi-arrow-repeat me-2"></i> Updates
              </a>
            </li>
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_tailscale_setup' %}">
                <i class="bi bi-shield-lock me-2"></i> Tailscale-Setup
              </a>
            </li>
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_system_status' %}">
                <i class="bi bi-activity me-2"></i> Systemstatus
              </a>
            </li>
          {% elif tailscale_setup_complete %}
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_tailscale_setup' %}">
                <i class="bi bi-shield-lock me-2"></i> Tailscale-Setup
              </a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>

    {% if request.user.is_superuser or tailscale_setup_complete %}
      <!-- Lagerorte, Kategorien & Tags -->
      <div class="col-12 col-lg-4">
        <div class="card h-100 shadow-sm" style="background:var(--surface); border:1px solid var(--border); border-radius:.75rem;">
          <div class="card-header fw-semibold" style="background:var(--surface-2); border-bottom:1px solid var(--border); color:var(--text);">
            üóÇÔ∏è Lagerorte, Kategorien &amp; Tags
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_storagelocations' %}">
                <i class="bi bi-diagram-3 me-2"></i> Lagerorte
              </a>
            </li>  
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_categories' %}">
                <i class="bi bi-folder2-open me-2"></i> Kategorien (√úbersicht)
              </a>
            </li>
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_tags_overview' %}">
                <i class="bi bi-tags me-2"></i> Tags (√úbersicht)
              </a>
            </li>
          </ul>
        </div>
      </div>
    {% endif %}

    {% if request.user.is_superuser or tailscale_setup_complete %}
      <!-- Items & Vorg√§nge -->
      <div class="col-12 col-lg-4">
        <div class="card h-100 shadow-sm" style="background:var(--surface); border:1px solid var(--border); border-radius:.75rem;">
          <div class="card-header fw-semibold" style="background:var(--surface-2); border-bottom:1px solid var(--border); color:var(--text);">
            üì¶ Items &amp; Vorg√§nge
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_items' %}">
                <i class="bi bi-box-seam me-2"></i> Items
              </a>
            </li>
            {% if global_features.show_admin_history %}
              <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
                <a class="text-decoration-none" href="{% url 'admin_history_list' %}">
                  <i class="bi bi-clock-history me-2"></i> Historie &amp; Rollback
                </a>
              </li>
            {% endif %}
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_borrowed_items' %}">
                <i class="bi bi-arrow-left-right me-2"></i> Entleih-Vorg√§nge
              </a>
            </li>
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_qr_codes' %}">
                <i class="bi bi-upc-scan me-2"></i> QR-Code √úbersicht
              </a>
            </li>
            <li class="list-group-item" style="background:var(--surface); border-color:var(--border);">
              <a class="text-decoration-none" href="{% url 'admin_overviews' %}">
                <i class="bi bi-columns-gap me-2"></i> Dashboards (Overviews)
              </a>
            </li>
          </ul>
        </div>
      </div>
    {% endif %}

    </div>
  {% endif %}

  {% if (request.user.is_superuser or tailscale_setup_complete) and global_features.show_feedback %}
    <!-- Feedback-Box -->
    <div class="row g-4 mt-1">
      <div class="col-12">
        <div class="card shadow-sm" style="background:var(--surface); border:1px solid var(--border); border-radius:.75rem;">
          <div class="card-header d-flex justify-content-between align-items-center fw-semibold" style="background:var(--surface-2); border-bottom:1px solid var(--border); color:var(--text);">
            üí¨ Letzte Feedbacks
            <a href="{% url 'feedback-list' %}" class="btn btn-sm btn-primary">Zur Feedback-√úbersicht</a>
          </div>
          <div class="card-body p-0">
            {% if latest_feedback %}
              <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" style="background:var(--surface); color:var(--text);">
                  <thead style="background:var(--surface-2); color:var(--text);">
                    <tr>
                      <th>Titel</th>
                      <th class="d-none d-md-table-cell">Erstellt von</th>
                      <th class="d-none d-md-table-cell">Erstellt am</th>
                      <th>Status</th>
                      <th class="text-end">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for fb in latest_feedback %}
                      <tr>
                        <td>
                          <a class="fw-semibold text-decoration-none" href="{% url 'feedback-detail' fb.id %}" style="color:#8bb8ff;">
                            {{ fb.title }}
                          </a>
                          {% if fb.description %}
                            <div class="small text-muted d-none d-lg-block">{{ fb.description|truncatewords:18 }}</div>
                          {% endif %}
                        </td>
                        <td class="d-none d-md-table-cell">{{ fb.created_by.username }}</td>
                        <td class="d-none d-md-table-cell">{{ fb.created_at|date:"d.m.Y H:i" }}</td>
                        <td>
                          <span class="badge
                            {% if fb.status == 'open' %} bg-danger
                            {% elif fb.status == 'in_progress' %} bg-warning text-dark
                            {% else %} bg-success {% endif %}">
                            {{ fb.get_status_display }}
                          </span>
                        </td>
                        <td class="text-end">
                          <div class="btn-group btn-group-sm" role="group" aria-label="Status √§ndern">
                            <!-- Offen -->
                            <form method="post" action="{% url 'admin_feedback_set_status' fb.id %}" class="d-inline">
                              {% csrf_token %}
                              <input type="hidden" name="status" value="open">
                              <button type="submit" class="btn {% if fb.status == 'open' %}btn-outline-light{% else %}btn-outline-secondary{% endif %}">
                                Offen
                              </button>
                            </form>
                            <!-- In Arbeit -->
                            <form method="post" action="{% url 'admin_feedback_set_status' fb.id %}" class="d-inline">
                              {% csrf_token %}
                              <input type="hidden" name="status" value="in_progress">
                              <button type="submit" class="btn {% if fb.status == 'in_progress' %}btn-outline-warning{% else %}btn-outline-secondary{% endif %}">
                                In&nbsp;Arbeit
                              </button>
                            </form>
                            <!-- Erledigt -->
                            <form method="post" action="{% url 'admin_feedback_set_status' fb.id %}" class="d-inline">
                              {% csrf_token %}
                              <input type="hidden" name="status" value="done">
                              <button type="submit" class="btn {% if fb.status == 'done' %}btn-outline-success{% else %}btn-outline-secondary{% endif %}">
                                Erledigt
                              </button>
                            </form>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="p-3 text-muted">Noch kein Feedback vorhanden.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}
