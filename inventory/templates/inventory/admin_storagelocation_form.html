{% extends "inventory/admin_base.html" %}
{% block admin_title %}Lagerort bearbeiten{% endblock %}

{% block admin_content %}
<div class="row justify-content-center g-4" style="color:var(--text);">
  <div class="col-lg-7">
    <div class="card shadow-sm" style="background:var(--surface); border:1px solid var(--border); border-radius:.75rem;">
      <div class="card-body">
        <h4 class="mb-4">
          <i class="bi bi-pencil-square me-2"></i>
          {% if is_create %}Lagerort anlegen{% else %}Lagerort bearbeiten{% endif %}
        </h4>
        <form method="post" novalidate>
          {% csrf_token %}
          <div class="mb-3">
            <label for="id_name" class="form-label">Name</label>
            {{ form.name }}
          </div>
          <div class="mb-3">
            <label for="id_nfc_token" class="form-label">NFC-Tag Token</label>
            {{ form.nfc_token }}
            <small class="text-muted d-block mt-1">
              Leer lassen, um automatisch einen Token zu erzeugen.
            </small>
            <details class="mt-2">
              <summary class="text-muted" style="cursor:pointer;">❓ Kurzanleitung</summary>
              <div class="mt-1">
                <ol class="mb-1">
                  <li>Lagerort speichern (Token wird erzeugt oder übernommen).</li>
                  <li>NFC-URL unten kopieren.</li>
                  <li>Die URL auf den NFC-Tag schreiben.</li>
                </ol>
              </div>
            </details>
          </div>
          {% if nfc_url %}
            <div class="mb-3">
              <label class="form-label">NFC-URL</label>
              <input class="form-control" type="text" value="{{ nfc_url }}" readonly>
            </div>
          {% endif %}
          <div class="mb-3">
            <label for="id_parent" class="form-label">Übergeordneter Lagerort (optional)</label>
            {{ form.parent }}
            <small class="text-muted d-block mt-1">
              Tipp: Lagerorte können verschachtelt werden (z. B. „Regal A → Fach 1 → Box 3“).
              Wähle hier den übergeordneten Lagerort oder lasse es leer für einen Hauptordner.
            </small>
          </div>
          <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check2-circle me-1"></i> Speichern
            </button>
            <a href="{% url 'admin_storagelocations' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i> Zurück
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card shadow-sm" style="background:var(--surface); border:1px solid var(--border); border-radius:.75rem;">
      <div class="card-body">
        <h5 class="mb-3"><i class="bi bi-diagram-3 me-2"></i>Hierarchie auswählen</h5>
        <p class="text-muted mb-3">
          Klicke auf einen vorhandenen Lagerort, um ihn als übergeordneten Stamm zu setzen.
          Für einen neuen Hauptordner wähle „Kein übergeordneter Lagerort“.
        </p>
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button type="button" class="btn btn-sm btn-outline-info storage-tree__item" data-parent-id="">
            Kein übergeordneter Lagerort
          </button>
          {% if parent_selected %}
            <span class="badge bg-success align-self-center">Aktuell ausgewählt</span>
          {% endif %}
        </div>
        {% if parent_tree %}
          {% include "inventory/partials/storage_location_tree.html" with nodes=parent_tree %}
        {% else %}
          <div class="text-muted">Noch keine Lagerorte vorhanden.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
  .storage-tree {
    margin: 0;
    padding-left: 1.25rem;
    border-left: 1px solid rgba(255, 255, 255, 0.08);
  }
  .storage-tree[data-level="0"] {
    border-left: none;
    padding-left: 0;
  }
  .storage-tree__node {
    position: relative;
    margin: 0.35rem 0;
    padding-left: 0.9rem;
  }
  .storage-tree__node::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0.95rem;
    width: 0.8rem;
    border-top: 1px solid rgba(255, 255, 255, 0.14);
  }
  .storage-tree__item.is-selected {
    background: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
  }
  .storage-tree__item {
    text-align: left;
    width: 100%;
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.12);
    font-weight: 500;
  }
  .storage-tree__item[data-level="0"] {
    font-weight: 700;
    background: rgba(13, 110, 253, 0.08);
  }
</style>

<script>
  (function () {
    const select = document.getElementById("id_parent");
    const buttons = document.querySelectorAll(".storage-tree__item");
    if (!select || !buttons.length) return;

    const setSelected = (value) => {
      select.value = value;
      buttons.forEach((btn) => {
        const isMatch = btn.dataset.parentId === value;
        btn.classList.toggle("is-selected", isMatch);
      });
    };

    setSelected(select.value || "");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        setSelected(btn.dataset.parentId || "");
      });
    });
  })();
</script>
{% endblock %}
